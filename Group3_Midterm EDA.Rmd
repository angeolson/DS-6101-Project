---
title: "Midterm EDA"
author: "Group 3: Pavani Samala, Ange Olson, Kowshik Bezawada, Meghana Gantla"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
options(scientific=T, digits = 3) 
library(ezids)
```

# Section I: Set-Up and Summary of the Dataset

First, we read in the data and set it up for analysis. The data is mostly cleaned, but we need a subset for calculating correlation, we need to change some data to be categorical, some data to be numerical, and we need to fix the dates so that they aren't read in as characters.

Without doing anything, our dataset is as follows:

```{r, results="markup"}
# read in dataset
airbnb <- data.frame(read.csv("NYC ABS.csv", header = TRUE))

#structure of dataset
str(airbnb)
```


```{r, echo = F}

# edit dates
airbnb$last_review <- as.Date(airbnb$last_review, format = "%m/%d/%Y")

# cast categorical variables
airbnb$neighbourhood_group <- as.factor(airbnb$neighbourhood_group)
airbnb$neighbourhood <- as.factor(airbnb$neighbourhood)
airbnb$room_type <- as.factor(airbnb$room_type)

# cast numerical variables as numeric
airbnb[ , c(10, 11, 12, 14, 15, 16)] <- lapply(airbnb[ , c(10, 11, 12, 14, 15, 16)], as.numeric)

# subset rows for correlation and cast as numeric
airbnb_cor <- airbnb[ , c(10, 11, 12, 14, 15, 16)]
```

After cleaning, our main dataset is described below:

```{r, results='markup'}
str(airbnb)
```

Our secondary dataset (used to measure correlation) is described below:

```{r, results='markup'}
str(airbnb_cor)
```

# Section II: Descriptive Statistics

Our dataset has `r nrow(airbnb)` observations. The continuous variables are described below (NA values omitted):

```{r, results = "markup", echo = F}
xkablesummary(na.omit(airbnb_cor))
```

```{r}
library(DescTools)
```

The standard deviations of the continuous variables are as follows:

*   `price`: `r sd(airbnb_cor$price)`
*   `minimum_nights`: `r sd(airbnb_cor$minimum_nights)`
*   `number_of_reviews`: `r sd(airbnb_cor$number_of_reviews)`
*   `reviews_per_month`: `r sd(na.omit(airbnb_cor$reviews_per_month))`
*   `calcualted_host_listings_count`: `r sd(airbnb_cor$calculated_host_listings_count)`
*   `availability_365`: `r sd(airbnb_cor$availability_365)`

The modes of the continuous variables are as follows:

*   `price`: `r Mode(airbnb_cor$price)`
*   `minimum_nights`: `r Mode(airbnb_cor$minimum_nights)`
*   `number_of_reviews`: `r Mode(airbnb_cor$number_of_reviews)`
*   `reviews_per_month`: `r Mode(na.omit(airbnb_cor$reviews_per_month))`
*   `calcualted_host_listings_count`: `r Mode(airbnb_cor$calculated_host_listings_count)`
*   `availability_365`: `r Mode(airbnb_cor$availability_365)`

The main categorical variables of interest are counted below:

```{r, results='markup'}

#neighborhood group
xkabledply(table(airbnb$neighbourhood_group))

#room_type
xkabledply(table(airbnb$room_type))
```

# Section III: Plots and Graphs

## Histogram for Price (All Observations)

First, we look at the price distribution for the entire dataset:

```{r, results = 'markup'}
library(ggplot2)
ggplot(data=airbnb, aes(price)) + 
  geom_histogram(bins = 100, 
                 col  = "dark blue", 
                 fill = "light blue", 
                alpha = .7) + # opacity
    labs(title = "Histogram of AirBnB Price (All Observations)", 
             x = "AirBnB Price", 
             y = "Frequency") +
     theme_grey()
```


## Q-Q plot for Price (All Observations)
```{r, results='markup'}
qqnorm(airbnb$price, pch = 20, main = "Q-Q Plot for AirBnB Prices (All Observations)")
qqline(airbnb$price, col = "black", lwd = 2)
```

Price is not normally distributed, and there appear to be a large number of outliers. If we remove those outliers, the distribution is close to normal. 

```{r, results='markup'}
airbnb_clean = outlierKD2(airbnb, price, rm = TRUE, boxplt = TRUE, qqplt = TRUE)
```

## Histogram for Price (Outliers Removed)

```{r, results = 'markup'}
library(ggplot2)
ggplot(data = airbnb_clean, aes(price)) +  
  geom_histogram(bins = 100, 
                 col  = "dark blue", 
                 fill = "light blue", 
                alpha = .7) +  # opacity
    labs(title = "Histogram of AirBnB Price (Outliers removed)", 
             x = "AirBnB Price", 
             y = "Frequency") +
     theme_grey()
```

## Q-Q plot for Price (Outliers Removed)
```{r, results='markup'}
qqnorm(airbnb_clean$price, pch = 20, main = "Q-Q Plot for AirBnB Prices (Outliers Removed)")
qqline(airbnb_clean$price, col = "black", lwd = 2)
```


## Scatter Plot for Price and Number of Reviews

Scatter plot for `price` and `number of reviews` without any transformations: 

```{r, results='markup'}
library(ggplot2)
library(ggpubr)
ggplot(airbnb, aes(x=price, y=number_of_reviews)) + 
  ggtitle("Number of Reviews vs Price Scatter Plot") + 
  xlab("Price ($)") + ylab("Number Of Reviews") + 
  geom_point(size = 1, shape = 18, color = "black") + 
  geom_smooth(method = lm, se = FALSE, color = "yellow", size = 1.2) + theme_bw() + 
  stat_cor(method =  "pearson", label.x = 6500 )
```

There appears to be a an exponential relationship (exponential decline) between `price` and `number of reviews`. 


Scatter plot for `price` and `number of reviews` taking the $$\log (reviews)$$ to show linear trend: 

```{r, results='markup'}
library(ggplot2)
library(ggpubr)
ggplot(airbnb, aes(x=price, y=log(number_of_reviews))) + 
  ggtitle("Number of Reviews vs Price Scatter Plot") + 
  xlab("Price ($)") + ylab("Number Of Reviews") + 
  geom_point(size = 1, shape = 18, color = "black") + 
  geom_smooth(method = lm, se = FALSE, color = "yellow", size = 1.2) + theme_bw() + 
  stat_cor(method =  "pearson", label.x = 6500 )
```

## Box Plot for Price and Neighborhood Group

Note: outliers extend past $1,000 per night, graph truncated for visibility and interpretation. 

```{r, results = "markup"}
library(ggplot2)
ggplot(airbnb, aes(price, factor(neighbourhood_group))) + 
  geom_boxplot(color = "black", fill = c("light green", "pink","light blue", "yellow", "orange")) +
  labs(title = "Neighbourhood Group vs Price Box plot", x = "Price", y = "Neighbourhood group") +
  xlim(0, 1000)
```

## Box Plot for Price and Room Type
Note: outliers extend past $1,000 per night, graph truncated for visibility and interpretation. 

```{r, results = "markup"}
library(ggplot2)
ggplot(airbnb, aes(price, factor(room_type))) + 
  geom_boxplot(width = 0.7, color = "black", fill = c("light green", "yellow","light blue")) +
  labs(title = "Room type vs Price Box plot", x = "Price", y = "Room Type") + xlim(0, 1000)
```


## Map of AirBnbs in NY by Neighbourhood group
```{r, results = 'markup'}
#install.packages("plotly")
library(plotly)

fig <- airbnb

fig <- fig %>%

  plot_ly(

    lat = ~latitude,

    lon = ~longitude,

    color = ~neighbourhood_group,
    
    colors = "Set1",

    type = 'scattermapbox')

fig <- fig %>%

  layout(

    mapbox = list(

      style = 'open-street-map',

      zoom =9,

      center = list(lon = -73.97, lat = 40.71))) 


fig
```


## AirBnB Average Price and Number of Listings by Neighborhood:

```{r}
# create subset just for aggregating by mean
airbnb_map <- airbnb[ , c(6, 7, 8, 10)]
airbnb_map_means <- aggregate(.~neighbourhood, airbnb_map, mean)

# create subset for aggregating by count
airbnb_count <- airbnb_map
airbnb_count$count <- 1
airbnb_count <- airbnb_count[, c(1,5)]
airbnb_counter <- aggregate(.~neighbourhood, airbnb_count, sum)

# create full dataset from both subsets
airbnb_map_full <- cbind(airbnb_counter, airbnb_map_means)

# check that union occured correctly, then drop extra neighborhood value
all.equal(airbnb_map_full[, 1], airbnb_map_full[, 3]) # true!
airbnb_map_full <- airbnb_map_full[, -3]
```

```{r, results = 'markup'}
#Load the library
library(ggplot2)
library(ggmap)

#Set your API Key
ggmap::register_google(key = "AIzaSyBuM2zUJqBlgjcki9tYS1emZr3awesSqac")

#map by price 
newyork.map <- get_map("New York", zoom = 10, scale = 1, maptype = "terrain")  
ggmap(newyork.map) +  geom_point(data = airbnb_map_full, aes(x = longitude, y = latitude, colour = price, size = count), alpha = 0.5) + 
  scale_colour_gradientn(colours=rainbow(3)) +
  labs(title = "Average AirBnb Price and Density by Neighborhood", x = "Longitude", y = "Latitude")
```

# Section IV: Correlation and ANOVA Tests

## Correlation
### Correlation Matrix for Airbnb Data
```{r, results = "markup"}
loadPkg("faraway")
loadPkg("corrplot")
xkabledply(cor(airbnb_cor))
airbnb_corplot = cor(airbnb_cor, use = "complete.obs")
corrplot(airbnb_corplot, method = "circle")
```

No strong correlations with price, but `minimum_nights` and `availability_365`, `number_of_reviews` and `availability_365`, and `calculated_host_listings_count` and `availability_365` show some evidence of positive correlation. 

### Correlation Between Reviews per Month and Total Reviews

```{r, results = "markup"}
cor.test(x=airbnb_cor$reviews_per_month, y=airbnb_cor$number_of_reviews)
```

As expected, correlated since reviews per month is a function of total number of reviews so do not need to look at both.


### Correlation Between Number of Reviews (Y) and Price (X) 

```{r, results = "markup"}
cor.test(y=airbnb$number_of_reviews, x=airbnb$price)
```

No evidence of strong (linear) correlation, but evidence of an inverse relationship between price and reviews (higher price, fewer reviews--possibly because of fewer stays, for which review number is probably a good proxy)


## ANOVA Tests

### Testing for Differences in Price by Neighborhood Group

```{r, results = "markup"}
#anova test for price and neighborhood groups
anova_price_group = aov(price ~ neighbourhood_group, data=airbnb)
summary(anova_price_group) -> sum_anova_price_group
xkabledply(sum_anova_price_group, title = "ANOVA result summary for Neighborhood Groups")

tukeyAoV_pg <- TukeyHSD(anova_price_group)
tukeyAoV_pg

```


### Testing for Differences in Price by Room Type

```{r, results = "markup"}
#anova test for price and room type
anova_price_room = aov(price ~ room_type, data=airbnb)
summary(anova_price_room) -> sum_anova_price_room
xkabledply(sum_anova_price_room, title = "ANOVA result summary for Room Type")

tukeyAoV_pr <- TukeyHSD(anova_price_room)
tukeyAoV_pr
```





